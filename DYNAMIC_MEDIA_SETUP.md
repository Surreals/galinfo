# üñºÔ∏è –î–∏–Ω–∞–º—ñ—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å - –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—é

## –©–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

### ‚úÖ Fallback –ª–æ–≥—ñ–∫–∞
- –Ø–∫—â–æ –Ω–µ–º–∞—î —Ñ–∞–π–ª—É –≤ –ø–∞–ø—Ü—ñ `intxt` –∞–±–æ `tmb` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–µ—Ä–µ—Ç—å—Å—è –∑ `full`
- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –Ω–∞ –ª—å–æ—Ç—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —Ä–æ–∑–º—ñ—Ä–∞–º–∏

### ‚úÖ –î–∏–Ω–∞–º—ñ—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤
- **Full**: –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–±–µ–∑ –∑–º—ñ–Ω)
- **Intxt**: 800x600px, —è–∫—ñ—Å—Ç—å 85% (–¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç—É)  
- **Tmb**: 150x150px, —è–∫—ñ—Å—Ç—å 80% (–¥–ª—è –º—ñ–Ω—ñ–∞—Ç—é—Ä)

### ‚úÖ URL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
http://89.116.31.189/media/gallery/full/1/7/file.jpg  ‚Üê –ü–æ–≤–Ω–µ —Ñ–æ—Ç–æ
http://89.116.31.189/media/gallery/intxt/1/7/file.jpg ‚Üê –°–µ—Ä–µ–¥–Ω—î (800px)
http://89.116.31.189/media/gallery/tmb/1/7/file.jpg   ‚Üê –ú—ñ–Ω—ñ–∞—Ç—é—Ä–∞ (150px)
```

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è nginx

### 1. –û–Ω–æ–≤—ñ—Ç—å –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é nginx

–î–æ–¥–∞–π—Ç–µ –¥–æ –≤–∞—à–æ–≥–æ nginx –∫–æ–Ω—Ñ—ñ–≥—É:

```nginx
server {
    listen 80;
    server_name 89.116.31.189;
    
    root /var/media/galinfo;
    
    # –û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ fallback –Ω–∞ API
    location ~ ^/media/gallery/(tmb|intxt|full)/(.+)$ {
        set $size $1;
        set $path $2;
        
        # –°–ø–æ—á–∞—Ç–∫—É —à—É–∫–∞—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω–∏–π —Ñ–∞–π–ª
        try_files /gallery/$size/$path @nextjs_media;
        
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Fallback –Ω–∞ Next.js API
    location @nextjs_media {
        proxy_pass http://localhost:3000/api/media/gallery/$size/$path$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # –Ü–Ω—à—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ Next.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å nginx

```bash
sudo nginx -t                    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
sudo systemctl reload nginx     # –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ä–æ–±–æ—Ç—É

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ Next.js –∑–∞–ø—É—â–µ–Ω–∏–π
pm2 list

# –¢–µ—Å—Ç–æ–≤—ñ –∑–∞–ø–∏—Ç–∏
curl -I http://89.116.31.189/media/gallery/full/4/0/4041.png
curl -I http://89.116.31.189/media/gallery/tmb/4/0/4041.png
```

## –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

### üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É

1. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ø–∏—Ç—É—î**: `http://89.116.31.189/media/gallery/tmb/1/7/file.jpg`

2. **Nginx –ø–µ—Ä–µ–≤—ñ—Ä—è—î**: —á–∏ —ñ—Å–Ω—É—î —Ñ–∞–π–ª `/var/media/galinfo/gallery/tmb/1/7/file.jpg`

3. **–Ø–∫—â–æ —Ñ–∞–π–ª —ñ—Å–Ω—É—î** ‚Üí nginx –≤—ñ–¥–¥–∞—î –π–æ–≥–æ –Ω–∞–ø—Ä—è–º—É (—à–≤–∏–¥–∫–æ!)

4. **–Ø–∫—â–æ —Ñ–∞–π–ª—É –Ω–µ–º–∞—î** ‚Üí nginx –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç –Ω–∞ Next.js API

5. **Next.js API**:
   - –ß–∏—Ç–∞—î –æ—Ä–∏–≥—ñ–Ω–∞–ª –∑ `/var/media/galinfo/gallery/full/1/7/file.jpg`
   - –ì–µ–Ω–µ—Ä—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Sharp
   - –ó–±–µ—Ä—ñ–≥–∞—î –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ `/var/media/galinfo/gallery/tmb/1/7/file.jpg`
   - –ü–æ–≤–µ—Ä—Ç–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É

6. **–ù–∞—Å—Ç—É–ø–Ω—ñ –∑–∞–ø–∏—Ç–∏** –¥–æ —Ç–æ–≥–æ –∂ —Ñ–∞–π–ª—É –±—É–¥—É—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è —à–≤–∏–¥–∫–æ nginx (–∫–µ—à—É–≤–∞–Ω–Ω—è!)

### üìä –ü–µ—Ä–µ–≤–∞–≥–∏ —Å–∏—Å—Ç–µ–º–∏

- ‚ö° **–®–≤–∏–¥–∫—ñ—Å—Ç—å**: –°—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏ –≤—ñ–¥–¥–∞—é—Ç—å—Å—è nginx –Ω–∞–ø—Ä—è–º—É
- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ—Å—Ç—å**: –†–æ–∑–º—ñ—Ä–∏ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –∑–∞ –ø–æ—Ç—Ä–µ–±–æ—é
- üíæ **–ö–µ—à—É–≤–∞–Ω–Ω—è**: –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¥–ª—è –º–∞–π–±—É—Ç–Ω—ñ—Ö –∑–∞–ø–∏—Ç—ñ–≤
- üîß **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è —Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤ JPG
- üõ°Ô∏è **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å**: Fallback –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä —è–∫—â–æ —â–æ—Å—å –Ω–µ —Ç–∞–∫

### üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤ –ø—ñ—Å–ª—è —Ä–æ–±–æ—Ç–∏

```
/var/media/galinfo/gallery/
‚îú‚îÄ‚îÄ full/
‚îÇ   ‚îú‚îÄ‚îÄ 1/7/1761574574725_59m3t1s5ikd.jpg  ‚Üê –û—Ä–∏–≥—ñ–Ω–∞–ª
‚îÇ   ‚îî‚îÄ‚îÄ 4/0/4041.png                       ‚Üê –û—Ä–∏–≥—ñ–Ω–∞–ª
‚îú‚îÄ‚îÄ intxt/                                 ‚Üê –ì–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
‚îÇ   ‚îú‚îÄ‚îÄ 1/7/1761574574725_59m3t1s5ikd.jpg  ‚Üê 800px –≤–µ—Ä—Å—ñ—è
‚îÇ   ‚îî‚îÄ‚îÄ 4/0/4041.jpg                       ‚Üê 800px –≤–µ—Ä—Å—ñ—è (PNG‚ÜíJPG)
‚îî‚îÄ‚îÄ tmb/                                   ‚Üê –ì–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
    ‚îú‚îÄ‚îÄ 1/7/1761574574725_59m3t1s5ikd.jpg  ‚Üê 150px –≤–µ—Ä—Å—ñ—è
    ‚îî‚îÄ‚îÄ 4/0/4041.jpg                       ‚Üê 150px –≤–µ—Ä—Å—ñ—è (PNG‚ÜíJPG)
```

## –ù–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ nginx
```bash
sudo tail -f /var/log/nginx/galinfo_access.log
sudo tail -f /var/log/nginx/galinfo_error.log
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Next.js API
```bash
# –ü—Ä—è–º–∏–π –∑–∞–ø–∏—Ç –¥–æ API
curl -I http://localhost:3000/api/media/gallery/tmb/4/0/4041.png
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏
```bash
ls -la /var/media/galinfo/gallery/full/4/0/
ls -la /var/media/galinfo/gallery/tmb/4/0/
```

–¢–µ–ø–µ—Ä –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—ñ–¥—Ç—Ä–∏–º—É—î —è–∫ —Å—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏, —Ç–∞–∫ —ñ –¥–∏–Ω–∞–º—ñ—á–Ω—É –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –∑–æ–±—Ä–∞–∂–µ–Ω—å! üéâ
