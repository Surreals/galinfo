# Система управління галереєю

## Огляд

Система управління галереєю надає повнофункціональний інтерфейс для роботи з зображеннями в адмінці. Реалізована схожа на систему управління відео з додатковими функціями для групових операцій.

## Функціональність

### 1. Перегляд зображень
- Табличний вигляд з прев'ю зображень
- Пагінація (20 зображень на сторінку за замовчуванням)
- Відображення назви, імені файлу та типу зображення

### 2. Пошук та фільтрація
- Пошук по назві зображення
- Пошук по імені файлу
- Фільтрація по типу зображення:
  - Новини
  - Галерея
  - Аватар
  - Банер

### 3. Групове завантаження
- Можливість завантажити декілька зображень одночасно
- Підтримка форматів: JPG, PNG, GIF, WebP
- Максимальний розмір файлу: 10MB
- Автоматичне створення трьох версій: full, tmb, intxt

### 4. Групові операції
- Вибір декількох зображень через чекбокси
- Групове видалення обраних зображень
- Підтвердження перед видаленням

### 5. Індивідуальні операції
- Редагування назви та типу зображення
- Перегляд повнорозмірного зображення
- Видалення окремого зображення

## API Endpoints

### GET /api/admin/images
Отримання списку зображень з пагінацією та фільтрацією.

**Query параметри:**
- `page` - номер сторінки (за замовчуванням: 1)
- `limit` - кількість зображень на сторінку (за замовчуванням: 20)
- `search` - текст для пошуку
- `pic_type` - тип зображення (news, gallery, avatar, banner)

**Відповідь:**
```json
{
  "images": [
    {
      "id": 1,
      "filename": "1234567890_abc.jpg",
      "title_ua": "Назва зображення",
      "title_deflang": "Назва зображення",
      "pic_type": "gallery",
      "url": "/media/gallery/full/1/2/1234567890_abc.jpg",
      "thumbnail_url": "/media/gallery/tmb/1/2/1234567890_abc.jpg"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### POST /api/admin/images/upload
Завантаження одного або декількох зображень.

**FormData параметри:**
- `file` або `files` - файл(и) зображень
- `title` - назва зображення (опціонально)
- `pic_type` - тип зображення (news, gallery, avatar, banner)

**Відповідь:**
```json
{
  "success": true,
  "images": [...],
  "uploaded": 3,
  "failed": 0,
  "errors": []
}
```

### PUT /api/admin/images/[id]
Редагування метаданих зображення.

**Body:**
```json
{
  "title_ua": "Нова назва",
  "title_deflang": "Нова назва",
  "pic_type": "gallery"
}
```

**Відповідь:**
```json
{
  "success": true,
  "image": {
    "id": 1,
    "filename": "1234567890_abc.jpg",
    "title_ua": "Нова назва",
    "title_deflang": "Нова назва",
    "pic_type": "gallery",
    "url": "/media/gallery/full/1/2/1234567890_abc.jpg",
    "thumbnail_url": "/media/gallery/tmb/1/2/1234567890_abc.jpg"
  }
}
```

### DELETE /api/admin/images/[id]
Видалення зображення.

**Відповідь:**
```json
{
  "success": true,
  "message": "Image deleted successfully"
}
```

### POST /api/admin/images/bulk-delete
Групове видалення зображень.

**Body:**
```json
{
  "ids": [1, 2, 3, 4, 5]
}
```

**Відповідь:**
```json
{
  "success": true,
  "message": "Successfully deleted 5 image(s)",
  "deleted": 5,
  "deletedFiles": 15,
  "failedFiles": 0
}
```

## Структура файлів

### Frontend
- `app/admin/gallery/page.tsx` - головна сторінка галереї
- `app/admin/gallery/gallery.module.css` - стилі для сторінки галереї

### API
- `app/api/admin/images/route.ts` - отримання списку зображень
- `app/api/admin/images/upload/route.ts` - завантаження зображень
- `app/api/admin/images/[id]/route.ts` - редагування та видалення зображення
- `app/api/admin/images/bulk-delete/route.ts` - групове видалення зображень

### Utilities
- `app/lib/imageUtils.ts` - утиліти для роботи з зображеннями

## Структура зберігання зображень

Зображення зберігаються в трьох розмірах:

```
media/gallery/
├── full/          # Повнорозмірні зображення
│   └── [перший_символ]/
│       └── [другий_символ]/
│           └── filename.jpg
├── tmb/           # Мініатюри
│   └── [перший_символ]/
│       └── [другий_символ]/
│           └── filename.jpg
└── intxt/         # Зображення для тексту
    └── [перший_символ]/
        └── [другий_символ]/
            └── filename.jpg
```

## Типи зображень

### 1. news (Новини)
Зображення для новинних статей.

### 2. gallery (Галерея)
Зображення для галереї (за замовчуванням).

### 3. avatar (Аватар)
Аватари користувачів.

### 4. banner (Банер)
Рекламні банери.

## База даних

### Таблиця a_pics

```sql
CREATE TABLE a_pics (
  id INT PRIMARY KEY AUTO_INCREMENT,
  filename VARCHAR(255) NOT NULL,
  title_ua VARCHAR(255),
  title_deflang VARCHAR(255),
  pic_type INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Мапінг pic_type:**
- 1 - news (Новини)
- 2 - gallery (Галерея)
- 3 - avatar (Аватар)
- 4 - banner (Банер)

## Використання

### Завантаження зображень

1. Перейдіть до `/admin/gallery`
2. Натисніть кнопку "Завантажити зображення"
3. Виберіть одне або декілька зображень
4. Вкажіть тип зображення
5. (Опціонально) Вкажіть назву
6. Натисніть "Завантажити"

### Редагування зображення

1. Знайдіть потрібне зображення в таблиці
2. Натисніть іконку редагування (олівець)
3. Змініть назву або тип
4. Натисніть "Зберегти"

### Групове видалення

1. Виберіть потрібні зображення через чекбокси
2. Натисніть кнопку "Видалити обрані (N)"
3. Підтвердіть видалення

### Пошук та фільтрація

1. Використовуйте поле пошуку для пошуку по назві або імені файлу
2. Використовуйте випадаючий список для фільтрації по типу
3. Результати оновляться автоматично

## Особливості реалізації

### Множинне завантаження
API підтримує завантаження як одного файлу (через параметр `file`), так і декількох файлів (через параметр `files`). Frontend надсилає всі файли через параметр `files`.

### Автоматичне створення підпапок
При завантаженні зображення автоматично створюються підпапки на основі перших двох символів імені файлу. Це забезпечує оптимальну структуру файлової системи при великій кількості файлів.

### Генерація унікальних імен
Імена файлів генеруються у форматі: `{timestamp}_{random}.{extension}`. Це гарантує унікальність і запобігає конфліктам імен.

### Обробка помилок
При груповому завантаженні, якщо якісь файли не вдалося завантажити, система продовжує обробку інших файлів і повертає детальну інформацію про успішні та невдалі завантаження.

### Підтримка старих зображень
Система автоматично визначає старі зображення (з попередньої версії сайту) та використовує відповідні URL для них.

## Безпека

- Всі API endpoints захищені аутентифікацією
- Перевірка типу файлів (тільки зображення)
- Обмеження розміру файлу (10MB)
- Валідація параметрів запитів
- Підтвердження перед видаленням

## Розширення функціональності

### Майбутні покращення

1. **Автоматична оптимізація зображень**
   - Створення реальних мініатюр (а не копій оригіналу)
   - Стиснення зображень
   - Конвертація в WebP

2. **Додаткові фільтри**
   - Фільтрація по даті завантаження
   - Фільтрація по розміру файлу
   - Сортування по різним полям

3. **Масові операції**
   - Масова зміна типу
   - Масове додавання тегів
   - Експорт списку зображень

4. **Інтеграція з редактором**
   - Обрізка зображень
   - Додавання водяних знаків
   - Налаштування якості стиснення

5. **Аналітика**
   - Статистика використання зображень
   - Виявлення невикористаних зображень
   - Звіти по розмірам файлів

## Troubleshooting

### Зображення не завантажуються
- Перевірте права доступу до папки `media/gallery`
- Переконайтеся що `MEDIA_STORAGE_PATH` налаштовано правильно
- Перевірте розмір файлу (максимум 10MB)

### Зображення не відображаються
- Перевірте що файли існують в файловій системі
- Переконайтеся що шляхи правильно налаштовані
- Перевірте консоль браузера на помилки

### Помилки при видаленні
- Переконайтеся що файли не використовуються в новинах
- Перевірте права доступу до папки
- Перегляньте логи сервера

## Підтримка

При виникненні проблем або питань звертайтеся до технічної документації або команди розробки.

