# –î–≤–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è (2FA) –∑ Google Authenticator

## –û–≥–ª—è–¥

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ø–æ–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–≤–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ—ó –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (2FA) –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ —Å–∞–π—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ **Google Authenticator** –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤.

## üéØ –û—Å–Ω–æ–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

- ‚úÖ **Google Authenticator** —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ QR –∫–æ–¥–æ–º
- ‚úÖ **–†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏** (10 –∫–æ–¥—ñ–≤) –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É
- ‚úÖ **–ö—Ä–æ–∫-–∑–∞-–∫—Ä–æ–∫–æ–º** –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è 2FA
- ‚úÖ **–ë–µ–∑–ø–µ—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è** –∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è–º –ø–∞—Ä–æ–ª–µ–º
- ‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥—ñ** –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤
- ‚úÖ **–ü–æ–≤–Ω—ñ—Å—Ç—é –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–π UI** –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö —Ç–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ–≤

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

### API Endpoints

```
/app/api/admin/2fa/
‚îú‚îÄ‚îÄ enable/route.ts      - –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–µ–∫—Ä–µ—Ç–∞ —ñ QR –∫–æ–¥—É
‚îú‚îÄ‚îÄ verify/route.ts      - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ OTP –∞–±–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–¥—É
‚îú‚îÄ‚îÄ disable/route.ts     - –í–∏–º–∫–Ω–µ–Ω–Ω—è 2FA
‚îî‚îÄ‚îÄ status/route.ts      - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É 2FA
```

### Frontend Components

```
/app/login/
‚îú‚îÄ‚îÄ page.tsx             - –õ–æ–≥—ñ–Ω —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é 2FA
‚îú‚îÄ‚îÄ TwoFactorPage.tsx    - –°—Ç–æ—Ä—ñ–Ω–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è OTP –∫–æ–¥—É
‚îî‚îÄ‚îÄ login.module.css     - –°—Ç–∏–ª—ñ –¥–ª—è –ª–æ–≥—ñ–Ω—É —Ç–∞ 2FA

/app/admin/settings/2fa/
‚îú‚îÄ‚îÄ page.tsx             - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è 2FA –≤ –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—ñ
‚îî‚îÄ‚îÄ twofa.module.css     - –°—Ç–∏–ª—ñ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å

/app/api/admin/
‚îî‚îÄ‚îÄ login/route.ts       - –û–Ω–æ–≤–ª–µ–Ω–∏–π API –ª–æ–≥—ñ–Ω—É –∑ 2FA
```

### Database Migration

```
/scripts/
‚îî‚îÄ‚îÄ add-2fa-fields.js    - SQL –º—ñ–≥—Ä–∞—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ 2FA
```

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

### –¢–∞–±–ª–∏—Ü—è `a_powerusers`

–î–æ–¥–∞–Ω—ñ –Ω–æ–≤—ñ –ø–æ–ª—è:

```sql
ALTER TABLE a_powerusers
ADD COLUMN twofa_secret VARCHAR(255) NULL DEFAULT NULL COMMENT '2FA secret key for Google Authenticator';

ALTER TABLE a_powerusers
ADD COLUMN twofa_enabled TINYINT(1) NOT NULL DEFAULT 0 COMMENT '1 if 2FA is enabled, 0 otherwise';

ALTER TABLE a_powerusers
ADD COLUMN backup_codes TEXT NULL DEFAULT NULL COMMENT 'JSON array of backup codes for 2FA recovery';
```

**–ü–æ–ª—è:**

- `twofa_secret` (VARCHAR 255) - —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á –¥–ª—è TOTP
- `twofa_enabled` (TINYINT 1) - –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —á–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ 2FA
- `backup_codes` (TEXT) - JSON –º–∞—Å–∏–≤ —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤

## üöÄ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

### 1. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

```bash
npm install speakeasy qrcode --legacy-peer-deps
npm install -D @types/speakeasy @types/qrcode --legacy-peer-deps
```

**–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏:**

- `speakeasy` - –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ TOTP (Time-based One-Time Password)
- `qrcode` - –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è QR –∫–æ–¥—ñ–≤ –¥–ª—è Google Authenticator
- `@types/*` - —Ç–∏–ø–∏ TypeScript

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

```bash
node scripts/add-2fa-fields.js
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—Å—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—é `a_powerusers`.

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —Å—Ç–æ—Ä—ñ–Ω–æ–∫

- **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è 2FA:** `/admin/settings/2fa`
- **–õ–æ–≥—ñ–Ω:** `/login`

## üîê –Ø–∫ –ø—Ä–∞—Ü—é—î 2FA

### Flow –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó 2FA

```
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí "–£–≤—ñ–º–∫–Ω—É—Ç–∏ 2FA"
   ‚Üì
2. API –≥–µ–Ω–µ—Ä—É—î —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á (speakeasy.generateSecret)
   ‚Üì
3. –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è QR –∫–æ–¥ –∑ URL –¥–ª—è Google Authenticator
   ‚Üì
4. –ì–µ–Ω–µ—Ä—É—é—Ç—å—Å—è 10 —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤ (8 —Å–∏–º–≤–æ–ª—ñ–≤ –∫–æ–∂–µ–Ω)
   ‚Üì
5. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∫–∞–Ω—É—î QR –∫–æ–¥
   ‚Üì
6. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥ –∑ Google Authenticator
   ‚Üì
7. API –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∫–æ–¥ (speakeasy.totp.verify)
   ‚Üì
8. 2FA –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è (twofa_enabled = 1)
   ‚Üì
9. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–±–µ—Ä—ñ–≥–∞—î —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏
```

### Flow –≤—Ö–æ–¥—É –∑ 2FA

```
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å
   ‚Üì
2. API –ø–µ—Ä–µ–≤—ñ—Ä—è—î credentials
   ‚Üì
3. –Ø–∫—â–æ twofa_enabled = 1 ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î requiresTwoFactor: true
   ‚Üì
4. –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è OTP
   ‚Üì
5. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥ –∞–±–æ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –∫–æ–¥
   ‚Üì
6. API –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∫–æ–¥
   ‚Üì
7. –Ø–∫—â–æ –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π ‚Üí –≤–∏–¥–∞—î—Ç—å—Å—è token —ñ –¥–æ—Å—Ç—É–ø
```

### Flow –≤–∏–º–∫–Ω–µ–Ω–Ω—è 2FA

```
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí "–í–∏–º–∫–Ω—É—Ç–∏ 2FA"
   ‚Üì
2. –ó–∞–ø–∏—Ç –ø–∞—Ä–æ–ª—è –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
   ‚Üì
3. API –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø–∞—Ä–æ–ª—å (MD5 hash)
   ‚Üì
4. –û—á–∏—â–∞—é—Ç—å—Å—è –ø–æ–ª—è: twofa_secret, twofa_enabled, backup_codes
   ‚Üì
5. 2FA –≤–∏–º–∫–Ω–µ–Ω–æ
```

## üì± –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Google Authenticator

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É

**iOS:**

- [Google Authenticator –≤ App Store](https://apps.apple.com/app/google-authenticator/id388497605)

**Android:**

- [Google Authenticator –≤ Google Play](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2)

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Google Authenticator
2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "+" (–¥–æ–¥–∞—Ç–∏ –∞–∫–∞—É–Ω—Ç)
3. –û–±–µ—Ä—ñ—Ç—å "–°–∫–∞–Ω—É–≤–∞—Ç–∏ QR –∫–æ–¥"
4. –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥
5. –ê–∫–∞—É–Ω—Ç "GalInfo Admin" –∑'—è–≤–∏—Ç—å—Å—è –≤ –¥–æ–¥–∞—Ç–∫—É
6. –ö–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –Ω–æ–≤–∏–π 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–±–µ–∑ QR –∫–æ–¥—É)

–Ø–∫—â–æ –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ñ–¥—Å–∫–∞–Ω—É–≤–∞—Ç–∏ QR:

1. –û–±–µ—Ä—ñ—Ç—å "–í–≤–µ—Å—Ç–∏ –∫–ª—é—á –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"
2. –ù–∞–∑–≤–∞ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É: `GalInfo Admin`
3. –ö–ª—é—á: `[—Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É]`
4. –¢–∏–ø: –ù–∞ –æ—Å–Ω–æ–≤—ñ —á–∞—Å—É

## üîë –†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏

### –©–æ —Ü–µ?

–†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏ - —Ü–µ 10 –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏—Ö –∫–æ–¥—ñ–≤ –ø–æ 8 —Å–∏–º–≤–æ–ª—ñ–≤, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∑–∞–º—ñ—Å—Ç—å OTP –∫–æ–¥—É.

**–§–æ—Ä–º–∞—Ç:** `ABC12DEF` (–∑–∞–≥–ª–∞–≤–Ω—ñ –±—É–∫–≤–∏ —Ç–∞ —Ü–∏—Ñ—Ä–∏)

### –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?

- ‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ –¥–æ—Å—Ç—É–ø –¥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∑ Google Authenticator
- ‚ùå –¢–µ–ª–µ—Ñ–æ–Ω —Ä–æ–∑—Ä—è–¥–∏–≤—Å—è
- ‚ùå –î–æ–¥–∞—Ç–æ–∫ Google Authenticator –Ω–µ –ø—Ä–∞—Ü—é—î
- ‚ùå –ù–µ –º–æ–∂–µ—Ç–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–¥

### –í–∞–∂–ª–∏–≤–æ!

‚ö†Ô∏è **–ö–æ–∂–µ–Ω –∫–æ–¥ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑**
‚ö†Ô∏è **–ó–±–µ—Ä—ñ–≥–∞–π—Ç–µ –∫–æ–¥–∏ –≤ –±–µ–∑–ø–µ—á–Ω–æ–º—É –º—ñ—Å—Ü—ñ**
‚ö†Ô∏è **–ù–µ –¥—ñ–ª—ñ—Ç—å—Å—è –∫–æ–¥–∞–º–∏ –∑ —ñ–Ω—à–∏–º–∏**

### –î–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏?

1. **–ü–∞–ø–µ—Ä–æ–≤–∏–π –∑–∞–ø–∏—Å** –≤ —Å–µ–π—Ñ—ñ
2. **–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª—ñ–≤** (1Password, LastPass, Bitwarden)
3. **–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª** –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä—ñ
4. **–ó–∞—Ö–∏—â–µ–Ω–∞ –Ω–æ—Ç–∞—Ç–∫–∞** –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ

## üõ†Ô∏è API Endpoints

### 1. Enable 2FA

```http
POST /api/admin/2fa/enable
Content-Type: application/json

{
  "userId": 1
}
```

**Response:**

```json
{
  "success": true,
  "secret": "JBSWY3DPEHPK3PXP",
  "qrCode": "data:image/png;base64,...",
  "backupCodes": [
    "ABC12DEF",
    "GHI34JKL",
    ...
  ],
  "otpauth_url": "otpauth://totp/GalInfo..."
}
```

### 2. Verify Token

```http
POST /api/admin/2fa/verify
Content-Type: application/json

{
  "userId": 1,
  "token": "123456",
  "isLogin": false
}
```

**Response:**

```json
{
  "success": true,
  "message": "Token verified",
  "remainingBackupCodes": 10
}
```

### 3. Disable 2FA

```http
POST /api/admin/2fa/disable
Content-Type: application/json

{
  "userId": 1,
  "password": "mypassword"
}
```

**Response:**

```json
{
  "success": true,
  "message": "2FA disabled successfully"
}
```

### 4. Check Status

```http
GET /api/admin/2fa/status?userId=1
```

**Response:**

```json
{
  "enabled": true,
  "backupCodesCount": 8
}
```

## üé® UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### –°—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å 2FA

**–®–ª—è—Ö:** `/admin/settings/2fa`

**–§—É–Ω–∫—Ü—ñ—ó:**

- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å—É (—É–≤—ñ–º–∫–Ω–µ–Ω–æ/–≤–∏–º–∫–Ω–µ–Ω–æ)
- –ö–Ω–æ–ø–∫–∞ "–£–≤—ñ–º–∫–Ω—É—Ç–∏ 2FA"
- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ 3 –∫—Ä–æ–∫–∞–º–∏:
  1. –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è QR –∫–æ–¥—É
  2. –í–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
  3. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤
- –ö–Ω–æ–ø–∫–∞ "–í–∏–º–∫–Ω—É—Ç–∏ 2FA" (–ø–æ—Ç—Ä–µ–±—É—î –ø–∞—Ä–æ–ª—å)
- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ 2FA

### –°—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—Ö–æ–¥—É –∑ 2FA

**–®–ª—è—Ö:** `/login`

**–§—É–Ω–∫—Ü—ñ—ó:**

- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ª–æ–≥—ñ–Ω (username/password)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ OTP, —è–∫—â–æ 2FA —É–≤—ñ–º–∫–Ω–µ–Ω–æ
- –í–≤–µ–¥–µ–Ω–Ω—è 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥—É
- –ö–Ω–æ–ø–∫–∞ "–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –∫–æ–¥"
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –¥–æ –≤—Ö–æ–¥—É"

## üîí –ë–µ–∑–ø–µ–∫–∞

### –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∑–∞—Ö–æ–¥–∏

1. **TOTP —Å—Ç–∞–Ω–¥–∞—Ä—Ç (RFC 6238)**

   - Time-based One-Time Password
   - 30-—Å–µ–∫—É–Ω–¥–Ω–µ –≤—ñ–∫–Ω–æ
   - 6-–∑–Ω–∞—á–Ω—ñ –∫–æ–¥–∏

2. **–†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏**

   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
   - –í–∏–¥–∞–ª—è—é—Ç—å—Å—è –ø—ñ—Å–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
   - 8 —Å–∏–º–≤–æ–ª—ñ–≤ (–±—É–∫–≤–∏ + —Ü–∏—Ñ—Ä–∏)

3. **Clock Skew**

   - Window = 2 (–¥–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è ¬±60 —Å–µ–∫—É–Ω–¥)
   - –ö–æ–º–ø–µ–Ω—Å—É—î —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ –≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤

4. **–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª–µ–º**

   - –ü—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–Ω—ñ 2FA –ø–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å
   - MD5 —Ö–µ—à (–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —ñ—Å–Ω—É—é—á—ñ–π —Å–∏—Å—Ç–µ–º—ñ)

5. **–ë–µ–∑–ø–µ—á–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è**
   - –°–µ–∫—Ä–µ—Ç –≤ –ë–î (base32 encoded)
   - –†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏ –≤ JSON
   - –ù—ñ—è–∫–∏—Ö plain-text –ø–∞—Ä–æ–ª—ñ–≤

## üìä –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –†—É—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

#### 1. –ê–∫—Ç–∏–≤–∞—Ü—ñ—è 2FA

```bash
1. –£–≤—ñ–π—Ç–∏ –≤ –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å
2. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ /admin/settings/2fa
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–£–≤—ñ–º–∫–Ω—É—Ç–∏ 2FA"
4. –í—ñ–¥—Å–∫–∞–Ω—É–≤–∞—Ç–∏ QR –∫–æ–¥ —á–µ—Ä–µ–∑ Google Authenticator
5. –í–≤–µ—Å—Ç–∏ 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥
6. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —É—Å–ø—ñ—à–Ω—É –∞–∫—Ç–∏–≤–∞—Ü—ñ—é
7. –ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏
```

#### 2. –í—Ö—ñ–¥ –∑ 2FA

```bash
1. –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏
2. –í–≤–µ—Å—Ç–∏ –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å –Ω–∞ /login
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ OTP —Å—Ç–æ—Ä—ñ–Ω–∫—É
4. –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∑ Google Authenticator
5. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —É—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
```

#### 3. –í—Ö—ñ–¥ –∑ —Ä–µ–∑–µ—Ä–≤–Ω–∏–º –∫–æ–¥–æ–º

```bash
1. –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏
2. –í–≤–µ—Å—Ç–∏ –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –∫–æ–¥"
4. –í–≤–µ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –∫–æ–¥
5. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —É—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
6. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤ –∑–º–µ–Ω—à–∏–ª–∞—Å—å
```

#### 4. –í–∏–º–∫–Ω–µ–Ω–Ω—è 2FA

```bash
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ /admin/settings/2fa
2. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–í–∏–º–∫–Ω—É—Ç–∏ 2FA"
3. –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å
4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —É—Å–ø—ñ—à–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è
5. –í–∏–π—Ç–∏ —ñ –≤–≤—ñ–π—Ç–∏ –±–µ–∑ OTP –∫–æ–¥—É
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ë–î

```sql
-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å 2FA –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
SELECT
  id,
  uname,
  twofa_enabled,
  CASE WHEN twofa_secret IS NOT NULL THEN 'SET' ELSE 'NULL' END as secret_status,
  CASE WHEN backup_codes IS NOT NULL THEN
    JSON_LENGTH(backup_codes)
  ELSE 0 END as backup_codes_count
FROM a_powerusers
WHERE id = 1;
```

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: QR –∫–æ–¥ –Ω–µ —Å–∫–∞–Ω—É—î—Ç—å—Å—è

**–†—ñ—à–µ–Ω–Ω—è:**

1. –ó–±—ñ–ª—å—à–∏—Ç–∏ —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å –µ–∫—Ä–∞–Ω—É
2. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ä—É—á–Ω–µ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–ª—é—á–∞
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ Google Authenticator –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–¥ –Ω–µ –ø—Ä–∏–π–º–∞—î—Ç—å—Å—è

**–†—ñ—à–µ–Ω–Ω—è:**

1. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∞—Å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ —Ç–∞ —Å–µ—Ä–≤–µ—Ä—ñ (–º–∞—î –±—É—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π)
2. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–æ–¥ (–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫)
3. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –∫–æ–¥

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Ç—Ä–∞—á–µ–Ω–æ –¥–æ—Å—Ç—É–ø –¥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É

**–†—ñ—à–µ–Ω–Ω—è:**

1. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –∫–æ–¥
2. –Ø–∫—â–æ –Ω–µ–º–∞—î —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤ - –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
3. –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –≤–∏–º–∫–Ω—É—Ç–∏ 2FA —á–µ—Ä–µ–∑ –ë–î:

```sql
UPDATE a_powerusers
SET twofa_enabled = 0,
    twofa_secret = NULL,
    backup_codes = NULL
WHERE id = [USER_ID];
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Å—ñ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ

**–†—ñ—à–µ–Ω–Ω—è:**

1. –í–∏–º–∫–Ω—É—Ç–∏ 2FA (–ø–æ—Ç—Ä—ñ–±–µ–Ω OTP –∫–æ–¥)
2. –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–Ω–æ–≤—É - –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤—ñ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏
3. –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤—ñ –∫–æ–¥–∏

## üìö –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

- [RFC 6238 - TOTP](https://tools.ietf.org/html/rfc6238)
- [Google Authenticator](https://support.google.com/accounts/answer/1066447)
- [Speakeasy Documentation](https://www.npmjs.com/package/speakeasy)
- [QRCode Documentation](https://www.npmjs.com/package/qrcode)

## ‚úÖ Checklist –¥–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

- [x] –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ (speakeasy, qrcode)
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ –º—ñ–≥—Ä–∞—Ü—ñ—é –ë–î
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ API endpoints (enable, verify, disable, status)
- [x] –û–Ω–æ–≤–ª–µ–Ω–æ login flow
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤–≤–µ–¥–µ–Ω–Ω—è OTP
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ UI –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å 2FA
- [x] –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–¥–∏
- [x] –î–æ–¥–∞–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é QR –∫–æ–¥—É
- [x] –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–∏ –≤—Ö–æ–¥—ñ
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é

## üéâ –ì–æ—Ç–æ–≤–æ!

–°–∏—Å—Ç–µ–º–∞ 2FA –ø–æ–≤–Ω—ñ—Å—Ç—é –≥–æ—Ç–æ–≤–∞ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è. –¢–µ–ø–µ—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏ —Å–≤–æ—ó –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º —Ä—ñ–≤–Ω–µ–º –±–µ–∑–ø–µ–∫–∏ —á–µ—Ä–µ–∑ Google Authenticator!

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 7 –∂–æ–≤—Ç–Ω—è 2025  
**–í–µ—Ä—Å—ñ—è:** 1.0.0
